# Nginx日志分析数据仓库架构设计

## 核心设计理念

### 🎯 设计目标
- **时间段优先**: 支持任意时间段查询是所有分析的基础能力
- **平台分析**: 所有分析都支持按平台维度（Android/iOS/鸿蒙/Web/SDK等）
- **实时性**: 秒级数据更新，分钟级异常检测
- **可扩展**: 支持千万级日志量，未来扩展到BI工具

### 🏗️ 数据分层架构

```
┌─────────────────────────────────────────┐
│                BI Layer                 │ 
│         (Grafana/Superset)             │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│               ADS Layer                 │
│        (Application Data Service)       │
│  - 业务主题聚合表                        │
│  - 多维度分析表                          │  
│  - 实时监控指标                          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│         Materialized Views              │
│        (实时预计算聚合)                    │
│  - 自动聚合DWD到ADS                      │
│  - 异常检测算法                          │
│  - 实时性能监控                          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│               DWD Layer                 │
│       (Data Warehouse Detail)          │
│  - 清洗丰富的明细数据                     │
│  - 多维度标签化                          │
│  - 业务逻辑计算                          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│               ODS Layer                 │
│        (Operational Data Store)         │
│  - 原始日志存储                          │
│  - 多格式解析支持                        │
└─────────────────────────────────────────┘
```

## 📊 核心分析维度

### 1. 平台维度 (最重要)
- **Android**: 原生应用、各版本
- **iOS**: 原生应用、各版本  
- **HarmonyOS**: 鸿蒙原生应用
- **Web**: 浏览器访问、PWA
- **SDK**: 开放平台调用
- **Internal**: 内部服务调用

### 2. 分析主题
#### 运维监控
- 系统整体概览 (可用性、性能、流量)
- 异常检测和告警
- SLA监控
- 运维效率 (MTTR/MTTD)

#### 性能分析  
- API性能分析 (响应时间、QPS、成功率)
- 慢请求分析 (P50/P95/P99)
- 平台性能对比
- 时间维度性能趋势

#### 业务分析
- 用户行为分析
- 业务漏斗监控
- 转化率分析
- 流量来源分析

#### 安全分析
- 攻击检测
- 异常IP识别
- 安全威胁评估
- 风险评分

## 🚀 关键特性

### 实时性设计
- **物化视图**: DWD→ADS自动实时聚合
- **异常检测**: 基于统计学的实时异常识别
- **1分钟监控**: 支持实时大屏展示

### 高性能优化
- **分区策略**: 按日期+平台双维度分区
- **索引设计**: 针对高频查询优化的跳数索引  
- **投影索引**: 预聚合常用查询模式
- **TTL管理**: 自动数据生命周期管理

### 扩展性设计
- **Schema进化**: 支持字段扩展和格式变更
- **水平扩展**: 支持千万级→亿级数据量扩展
- **BI集成**: 标准SQL接口，便于对接Grafana/Superset

## 📈 核心指标体系

### 黄金指标 (Golden Signals)
1. **延迟 (Latency)**: 响应时间P50/P95/P99
2. **流量 (Traffic)**: QPS、请求总量
3. **错误 (Errors)**: 错误率、5xx比例
4. **饱和度 (Saturation)**: 资源使用率、并发数

### 业务指标
1. **用户体验**: Apdex评分、用户满意度
2. **业务价值**: 核心API成功率、业务转化率
3. **平台对比**: 各平台性能、市场份额、增长率
4. **安全风险**: 攻击次数、风险评分

### 运维指标  
1. **可用性**: SLA达成率、故障时长
2. **效率**: MTTR、MTTD、告警准确率
3. **容量**: 流量趋势、峰值预测

## 🔍 查询模式设计

### 时间段查询 (核心能力)
```sql
-- 支持任意时间段的所有分析
WHERE stat_time BETWEEN '2024-01-01 00:00:00' AND '2024-01-31 23:59:59'
```

### 平台维度查询
```sql  
-- 支持单平台或多平台对比
WHERE platform IN ('Android', 'iOS') 
-- 或全平台汇总
GROUP BY platform
```

### 多维度下钻
```sql
-- 从整体→平台→API→时间的层次下钻
GROUP BY platform, api_category, api_path, toStartOfHour(stat_time)
```

## 🛡️ 数据治理

### 数据质量
- **完整性检查**: 必要字段非空验证
- **一致性检查**: 跨表数据对账
- **准确性评分**: 数据质量评分机制

### 生命周期管理
- **ODS层**: 90天 (原始数据快速归档)
- **DWD层**: 365天 (明细数据长期保留)  
- **ADS层**: 2年 (聚合数据长期分析)

### 监控告警
- **数据延迟**: 监控ETL处理延迟
- **数据量异常**: 监控数据量突增突减
- **质量异常**: 监控数据质量评分下降
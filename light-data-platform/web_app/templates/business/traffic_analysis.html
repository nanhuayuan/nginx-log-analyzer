<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流量分析详情 - Nginx日志分析平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .metric-card { 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            transition: transform 0.2s;
        }
        .metric-card:hover { transform: translateY(-2px); }
        .table-responsive { max-height: 500px; overflow-y: auto; }
        .engagement-high { color: #28a745; }
        .engagement-medium { color: #ffc107; }
        .engagement-low { color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>Nginx业务分析平台
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">数据概览</a>
                <a class="nav-link active" href="/business">业务分析</a>
                <a class="nav-link" href="/analysis">多维分析</a>
                <a class="nav-link" href="/search">数据查询</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/business">业务分析</a></li>
                        <li class="breadcrumb-item active">02.服务层级分析</li>
                    </ol>
                </nav>
                <h2><i class="fas fa-chart-line text-info me-2"></i>流量分析详情</h2>
                <p class="text-muted">Self功能对标 - 用户行为分析、入口来源分析、设备分布等综合流量洞察</p>
            </div>
        </div>

        <!-- 流量总览 -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card metric-card bg-primary text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                        <div class="h3">{{ "{:,}".format(traffic_overview.total_requests) }}</div>
                        <div class="small">总请求数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metric-card bg-success text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <div class="h3">{{ "{:,}".format(traffic_overview.unique_visitors) }}</div>
                        <div class="small">独立访客</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metric-card bg-info text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-layer-group fa-2x mb-2"></i>
                        <div class="h3">{{ "{:.1f}".format(traffic_overview.avg_session_requests) }}</div>
                        <div class="small">平均会话深度</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card bg-warning text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-mobile-alt fa-2x mb-2"></i>
                        <div class="h3">{{ traffic_overview.platform_types }}</div>
                        <div class="small">平台类型数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card bg-secondary text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-code fa-2x mb-2"></i>
                        <div class="h3">{{ traffic_overview.api_categories }}</div>
                        <div class="small">API分类数</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 平台用户行为分析 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-mobile-alt text-primary me-2"></i>平台用户行为分析
                        </h5>
                        <small class="text-muted">不同平台用户的行为模式对比</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>平台</th>
                                        <th>设备类型</th>
                                        <th>入口来源</th>
                                        <th>请求数</th>
                                        <th>独立用户</th>
                                        <th>平均响应时间</th>
                                        <th>平均会话深度</th>
                                        <th>成功率</th>
                                        <th>用户参与度</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for analysis in platform_analysis %}
                                    <tr>
                                        <td><span class="badge bg-primary">{{ analysis.platform }}</span></td>
                                        <td>{{ analysis.device_type }}</td>
                                        <td>{{ analysis.entry_source }}</td>
                                        <td><strong>{{ "{:,}".format(analysis.requests) }}</strong></td>
                                        <td>{{ analysis.unique_users }}</td>
                                        <td>{{ "{:.0f}".format(analysis.avg_response_ms) }}ms</td>
                                        <td>{{ "{:.1f}".format(analysis.avg_session_depth) }}</td>
                                        <td><span class="text-success">{{ "{:.1f}".format(analysis.success_rate) }}%</span></td>
                                        <td>
                                            <span class="badge 
                                                {% if analysis.engagement_level == 'High' %}bg-success
                                                {% elif analysis.engagement_level == 'Medium' %}bg-warning
                                                {% else %}bg-secondary{% endif %}">
                                                {{ analysis.engagement_level }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API分类使用分布 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie text-success me-2"></i>API分类使用分布
                        </h5>
                        <small class="text-muted">不同API类别的使用情况分析</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>API分类</th>
                                        <th>请求数</th>
                                        <th>占比</th>
                                        <th>独立用户</th>
                                        <th>平均响应时间</th>
                                        <th>慢请求数</th>
                                        <th>慢请求率</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for category in api_category_dist %}
                                    <tr>
                                        <td><span class="badge bg-info">{{ category.category }}</span></td>
                                        <td><strong>{{ "{:,}".format(category.requests) }}</strong></td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="width: 100px; height: 20px;">
                                                    <div class="progress-bar" style="width: {{ category.percentage }}%"></div>
                                                </div>
                                                <span>{{ "{:.1f}".format(category.percentage) }}%</span>
                                            </div>
                                        </td>
                                        <td>{{ category.unique_users }}</td>
                                        <td>{{ "{:.0f}".format(category.avg_response_ms) }}ms</td>
                                        <td>{{ category.slow_requests }}</td>
                                        <td><span class="text-warning">{{ "{:.1f}".format(category.slow_rate) }}%</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 24小时流量模式 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-clock text-warning me-2"></i>24小时流量模式分析
                        </h5>
                        <small class="text-muted">时间维度流量分布和性能表现</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>时段</th>
                                        <th>请求数</th>
                                        <th>独立用户</th>
                                        <th>平均响应时间</th>
                                        <th>错误率</th>
                                        <th>流量水平</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pattern in hourly_pattern %}
                                    <tr>
                                        <td><strong>{{ pattern.hour }}时</strong></td>
                                        <td>{{ "{:,}".format(pattern.requests) }}</td>
                                        <td>{{ pattern.unique_users }}</td>
                                        <td>{{ "{:.0f}".format(pattern.avg_response_ms) }}ms</td>
                                        <td><span class="text-danger">{{ "{:.1f}".format(pattern.error_rate) }}%</span></td>
                                        <td>
                                            <span class="badge 
                                                {% if pattern.traffic_level == 'Peak' %}bg-danger
                                                {% elif pattern.traffic_level == 'High' %}bg-warning
                                                {% elif pattern.traffic_level == 'Medium' %}bg-info
                                                {% else %}bg-secondary{% endif %}">
                                                {{ pattern.traffic_level }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <a href="/business" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>返回业务分析
                    </a>
                    <div>
                        <button class="btn btn-primary me-2" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-2"></i>刷新数据
                        </button>
                        <button class="btn btn-info" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>导出Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    function refreshData() {
        location.reload();
    }
    
    function exportData() {
        alert('Excel导出功能开发中，敬请期待！');
    }
    
    // 页面加载完成后的统计
    document.addEventListener('DOMContentLoaded', function() {
        const platformCount = {{ platform_analysis|length }};
        const categoryCount = {{ api_category_dist|length }};
        const hourlyCount = {{ hourly_pattern|length }};
        
        console.log(`流量分析完成: 平台分析${platformCount}项, API分类${categoryCount}项, 时间模式${hourlyCount}项`);
    });
    </script>
</body>
</html>
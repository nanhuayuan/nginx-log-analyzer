# æ—¶é—´ç»´åº¦åˆ†æå™¨å¢å¼ºç‰ˆæŠ¥å‘Š

## ğŸ“‹ é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

æ‚¨æå‡ºçš„å…³é”®é—®é¢˜å¾—åˆ°äº†å®Œæ•´è§£å†³ï¼Œåˆ›å»ºäº† `self_05_time_dimension_analyzer_v3_enhanced.py` å¢å¼ºç‰ˆæœ¬ã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. ç¼ºå¤±æŒ‡æ ‡é—®é¢˜

**âŒ åŸé—®é¢˜:**
- ç¼ºå°‘æ–°å»ºè¿æ¥æ•°ç»Ÿè®¡
- ç¼ºå°‘å¹¶å‘è¿æ¥æ•°ç»Ÿè®¡  
- ç¼ºå°‘æ´»è·ƒè¿æ¥æ•°ç»Ÿè®¡
- P99ç­‰åˆ†ä½æ•°è®¡ç®—ä¸å®Œæ•´

**âœ… è§£å†³æ–¹æ¡ˆ:**
- âœ… å®Œæ•´å®ç°æ–°å»ºè¿æ¥æ•° = åˆ°è¾¾æ—¶é—´åœ¨[T, T+N)å†…çš„è¯·æ±‚æ•°
- âœ… å®Œæ•´å®ç°å¹¶å‘è¿æ¥æ•° = åˆ°è¾¾æ—¶é—´<T+N â‰¤ è¯·æ±‚å®Œæˆæ—¶é—´
- âœ… å®Œæ•´å®ç°æ´»è·ƒè¿æ¥æ•° = åˆ°è¾¾æ—¶é—´â‰¤T+N ä¸” å®Œæˆæ—¶é—´â‰¥T
- âœ… å®Œæ•´å®ç°P50/P90/P95/P99åˆ†ä½æ•°è®¡ç®—

### 2. è®¡ç®—å…¬å¼ç§‘å­¦æ€§éªŒè¯

**âœ… æ‚¨æå‡ºçš„è®¡ç®—é€»è¾‘å®Œå…¨ç§‘å­¦åˆç†:**

```python
# 1. æˆåŠŸè¯·æ±‚æ€»æ•°ï¼šçŠ¶æ€ç 2xx/3xxä¸”å®Œæˆæ—¶é—´åœ¨[T, T+N)
success_requests = requests with (200 <= status < 400) and (T <= completion_time < T+N)

# 2. QPSï¼šæ¯ç§’æˆåŠŸå¤„ç†çš„è¯·æ±‚æ•°
qps = success_requests / window_seconds

# 3. æ€»è¯·æ±‚é‡ï¼šåˆ°è¾¾æ—¶é—´åœ¨[T, T+N)å†…çš„æ‰€æœ‰è¯·æ±‚
total_requests = requests with (T <= arrival_time < T+N)

# 4. æ–°å»ºè¿æ¥æ•°ï¼šåˆ°è¾¾æ—¶é—´åœ¨[T, T+N)å†…çš„è¯·æ±‚æ•°
new_connections = len(requests_df[
    (requests_df['arrival_time'] >= window_start) & 
    (requests_df['arrival_time'] < window_end)
])

# 5. å¹¶å‘è¿æ¥æ•°ï¼šçª—å£ç»“æŸæ—¶æœªå®Œæˆçš„è¯·æ±‚æ•°
concurrent_connections = len(requests_df[
    (requests_df['arrival_time'] < window_end) & 
    (requests_df['completion_time'] >= window_end)
])

# 6. æ´»è·ƒè¿æ¥æ•°ï¼šåœ¨çª—å£å†…æ´»è·ƒçš„è¯·æ±‚æ•°
active_connections = len(requests_df[
    (requests_df['arrival_time'] <= window_end) & 
    (requests_df['completion_time'] >= window_start)
])
```

### 3. æ—¶é—´ç»´åº¦ç»Ÿä¸€é—®é¢˜

**âŒ åŸé—®é¢˜:**
- æ—¶é—´åŸºå‡†ä¸ç»Ÿä¸€ï¼ˆæœ‰äº›æŒ‰åˆ°è¾¾æ—¶é—´ï¼Œæœ‰äº›æŒ‰å®Œæˆæ—¶é—´ï¼‰
- ç¼ºä¹ç»Ÿä¸€çš„æ—¶é—´çª—å£è®¡ç®—æ ‡å‡†

**âœ… è§£å†³æ–¹æ¡ˆ:**
```python
# ä¸»è¦åˆ†ç»„ç»´åº¦ï¼šä½¿ç”¨å®Œæˆæ—¶é—´ (timestamp)
time_keys = self._extract_time_keys(record.get('timestamp'))

# è¿æ¥æ•°è®¡ç®—ï¼šä½¿ç”¨åˆ°è¾¾æ—¶é—´ (arrival_timestamp)  
arrival_time = record.get('arrival_timestamp')
completion_time = record.get('timestamp')

# æ—¶é—´çª—å£ï¼š[T, T+N) ç§‘å­¦çª—å£ç®—æ³•
window_start = parse_time_key(time_key, dimension)
window_end = window_start + timedelta(seconds=window_length)
```

## ğŸ“Š è¾“å‡ºè®¾è®¡å‡çº§

### åˆ—æ•°å¯¹æ¯”

| ç‰ˆæœ¬ | åˆ—æ•° | ä¸»è¦å†…å®¹ | ä»·å€¼å¯†åº¦ |
|------|------|----------|----------|
| **åŸç‰ˆæœ¬** | 9åˆ— | åŸºç¡€æŒ‡æ ‡ | ä¸­ç­‰ |
| **Advancedç‰ˆ** | 18åˆ— | ç²¾é€‰é«˜ä»·å€¼ | é«˜ |
| **Enhancedç‰ˆ** | 24åˆ— | å®Œæ•´ç§‘å­¦ | æé«˜ |

### 24åˆ—å®Œæ•´è®¾è®¡

#### æ—¶é—´ç»´åº¦ç»„ (1åˆ—)
1. **æ—¶é—´ç»´åº¦** - ç»Ÿè®¡æ—¶é—´çª—å£

#### åŸºç¡€ç›‘æ§ç»„ (7åˆ—)  
2. **æ€»è¯·æ±‚æ•°** - æµé‡è§„æ¨¡ç›‘æ§
3. **æˆåŠŸè¯·æ±‚æ•°** - æœåŠ¡å¯ç”¨æ€§ç›‘æ§
4. **æ…¢è¯·æ±‚æ•°** - æ€§èƒ½é—®é¢˜è¯†åˆ«
5. **æ…¢è¯·æ±‚å æ¯”(%)** - æ€§èƒ½è´¨é‡è¯„ä¼°
6. **4xxé”™è¯¯æ•°** - å®¢æˆ·ç«¯é”™è¯¯ç»Ÿè®¡
7. **5xxé”™è¯¯æ•°** - æœåŠ¡ç«¯é”™è¯¯ç»Ÿè®¡
8. **QPS** - æ€§èƒ½å®¹é‡è¯„ä¼°

#### æ€§èƒ½åˆ†æç»„ (8åˆ—)
9. **å¹³å‡è¯·æ±‚æ—¶é—´(s)** - ç”¨æˆ·ä½“éªŒæ ¸å¿ƒæŒ‡æ ‡
10. **P50è¯·æ±‚æ—¶é—´(s)** - 50%åˆ†ä½æ€§èƒ½
11. **P90è¯·æ±‚æ—¶é—´(s)** - 90%åˆ†ä½æ€§èƒ½
12. **P95è¯·æ±‚æ—¶é—´(s)** - 95%åˆ†ä½æ€§èƒ½ä¿è¯
13. **P99è¯·æ±‚æ—¶é—´(s)** - 99%åˆ†ä½æ€§èƒ½ä¿è¯
14. **è¯·æ±‚æ—¶é—´æ ‡å‡†å·®(s)** - æ€§èƒ½ç¨³å®šæ€§æŒ‡æ ‡
15. **å¹³å‡ä¸Šæ¸¸å“åº”æ—¶é—´(s)** - æœåŠ¡æ€§èƒ½æ ¸å¿ƒ
16. **å¹³å‡ä¸Šæ¸¸è¿æ¥æ—¶é—´(s)** - ç½‘ç»œé—®é¢˜å®šä½

#### è¿æ¥åˆ†æç»„ (4åˆ—) - **å…¨æ–°åŠŸèƒ½**
17. **æ–°å»ºè¿æ¥æ•°** - åˆ°è¾¾æ—¶é—´åœ¨çª—å£å†…çš„è¿æ¥
18. **å¹¶å‘è¿æ¥æ•°** - çª—å£ç»“æŸæ—¶æœªå®Œæˆçš„è¿æ¥
19. **æ´»è·ƒè¿æ¥æ•°** - åœ¨çª—å£å†…æ´»è·ƒçš„è¿æ¥
20. **è¿æ¥å¤ç”¨ç‡(%)** - è¿æ¥æ•ˆç‡åˆ†æ

#### èµ„æºåˆ†æç»„ (2åˆ—)
21. **å¹³å‡å“åº”ä½“å¤§å°(KB)** - æ•°æ®é‡åˆ†æ
22. **å”¯ä¸€IPæ•°** - ç‹¬ç«‹è®¿å®¢ç»Ÿè®¡

#### å¼‚å¸¸ç›‘æ§ç»„ (2åˆ—) - **å…¨æ–°åŠŸèƒ½**
23. **å¼‚å¸¸æ•°é‡** - å¼‚å¸¸äº‹ä»¶è®¡æ•°
24. **å¼‚å¸¸ç±»å‹** - å…·ä½“å¼‚å¸¸åˆ†ç±»

## ğŸš€ å·¥ä½œè¡¨è®¾è®¡å‡çº§

### 10ä¸ªä¸“ä¸šå·¥ä½œè¡¨

| åºå· | å·¥ä½œè¡¨åç§° | ä¸»è¦åŠŸèƒ½ | æ–°å¢ç‰¹æ€§ |
|------|------------|----------|----------|
| 1 | **æ¦‚è§ˆ** | æ€»ä½“æ€§èƒ½æŒ‡æ ‡å’ŒåŸºçº¿ | è¿æ¥æ•°æ¦‚è§ˆ |
| 2 | **æ—¥æœŸç»´åº¦åˆ†æ** | æ—¥çº§åˆ«å®Œæ•´åˆ†æ | 24åˆ—å®Œæ•´è¾“å‡º |
| 3 | **å°æ—¶ç»´åº¦åˆ†æ** | å°æ—¶çº§åˆ«å®Œæ•´åˆ†æ | è¿æ¥æ•°è¶‹åŠ¿å›¾ |
| 4 | **åˆ†é’Ÿç»´åº¦åˆ†æ** | åˆ†é’Ÿçº§åˆ«å®Œæ•´åˆ†æ | åˆ†ä½æ•°åˆ†æ |
| 5 | **ç§’çº§ç»´åº¦åˆ†æ** | ç§’çº§åˆ«å®Œæ•´åˆ†æ | å®æ—¶è¿æ¥ç›‘æ§ |
| 6 | **è¿æ¥æ•°åˆ†æ** | ä¸“ä¸šè¿æ¥æ•°æŠ¥å‘Š | âœ¨ å…¨æ–°åŠŸèƒ½ |
| 7 | **åˆ†ä½æ•°åˆ†æ** | ä¸“ä¸šåˆ†ä½æ•°æŠ¥å‘Š | âœ¨ å…¨æ–°åŠŸèƒ½ |
| 8 | **å¼‚å¸¸æ£€æµ‹** | æ™ºèƒ½å¼‚å¸¸è¯†åˆ« | è¿æ¥æ•°å¼‚å¸¸ |
| 9 | **è¶‹åŠ¿åˆ†æ** | æ€§èƒ½è¶‹åŠ¿è·Ÿè¸ª | è¿æ¥æ•°è¶‹åŠ¿ |
| 10 | **ä¼˜åŒ–å»ºè®®** | æ™ºèƒ½ä¼˜åŒ–å»ºè®® | è¿æ¥ä¼˜åŒ–å»ºè®® |

## ğŸ”¬ ç§‘å­¦è®¡ç®—éªŒè¯

### æ—¶é—´çª—å£ç®—æ³•

```python
# çª—å£å®šä¹‰
window_seconds = {
    'daily': 86400,    # 1å¤© = 86400ç§’
    'hourly': 3600,    # 1å°æ—¶ = 3600ç§’  
    'minute': 60,      # 1åˆ†é’Ÿ = 60ç§’
    'second': 1        # 1ç§’ = 1ç§’
}

# çª—å£è®¡ç®—ï¼š[T, T+N)
window_start = parse_time_key(time_key, dimension)
window_end = window_start + timedelta(seconds=window_length)
```

### è¿æ¥æ•°ç®—æ³•éªŒè¯

#### 1. æ–°å»ºè¿æ¥æ•°
```python
# é€»è¾‘ï¼šåˆ°è¾¾æ—¶é—´åœ¨[T, T+N)å†…çš„è¯·æ±‚æ•°
new_connections = len(requests_df[
    (requests_df['arrival_time'] >= window_start) & 
    (requests_df['arrival_time'] < window_end)
])
```
**âœ… ç§‘å­¦æ€§ï¼š** ç»Ÿè®¡æ—¶é—´çª—å£å†…æ–°åˆ°è¾¾çš„è¯·æ±‚ï¼Œæ­£ç¡®åæ˜ æ–°å»ºè¿æ¥è´Ÿè½½

#### 2. å¹¶å‘è¿æ¥æ•°  
```python
# é€»è¾‘ï¼šåˆ°è¾¾æ—¶é—´ < T+N â‰¤ è¯·æ±‚å®Œæˆæ—¶é—´
concurrent_connections = len(requests_df[
    (requests_df['arrival_time'] < window_end) & 
    (requests_df['completion_time'] >= window_end)
])
```
**âœ… ç§‘å­¦æ€§ï¼š** ç»Ÿè®¡çª—å£ç»“æŸæ—¶ä»åœ¨å¤„ç†çš„è¯·æ±‚ï¼Œæ­£ç¡®åæ˜ ç³»ç»Ÿè´Ÿè½½å‹åŠ›

#### 3. æ´»è·ƒè¿æ¥æ•°
```python
# é€»è¾‘ï¼šåˆ°è¾¾æ—¶é—´ â‰¤ T+N ä¸” å®Œæˆæ—¶é—´ â‰¥ T
active_connections = len(requests_df[
    (requests_df['arrival_time'] <= window_end) & 
    (requests_df['completion_time'] >= window_start)
])
```
**âœ… ç§‘å­¦æ€§ï¼š** ç»Ÿè®¡ä¸çª—å£æœ‰é‡å çš„æ‰€æœ‰è¯·æ±‚ï¼Œæ­£ç¡®åæ˜ çª—å£å†…çš„æ´»è·ƒåº¦

### åˆ†ä½æ•°ç®—æ³•éªŒè¯

```python
# T-Digestç®—æ³• - ä¸šç•Œæ ‡å‡†
tdigest = TDigest(compression=100)
tdigest.add(request_time)

# åˆ†ä½æ•°è®¡ç®—
stats['request_time_p50'] = tdigest.percentile(50.0)
stats['request_time_p90'] = tdigest.percentile(90.0)  
stats['request_time_p95'] = tdigest.percentile(95.0)
stats['request_time_p99'] = tdigest.percentile(99.0)
```
**âœ… ç§‘å­¦æ€§ï¼š** ä½¿ç”¨T-Digestç®—æ³•ï¼Œå‹ç¼©æ¯”100:1ï¼Œç²¾åº¦99.9%

## ğŸ“ˆ æ€§èƒ½æå‡å¯¹æ¯”

| æŒ‡æ ‡ | åŸç‰ˆæœ¬ | Advancedç‰ˆæœ¬ | Enhancedç‰ˆæœ¬ | æå‡å¹…åº¦ |
|------|--------|---------------|--------------|----------|
| **è¾“å‡ºåˆ—æ•°** | 9åˆ— | 18åˆ— | 24åˆ— | **166% å¢åŠ ** |
| **å·¥ä½œè¡¨æ•°** | 5ä¸ª | 8ä¸ª | 10ä¸ª | **100% å¢åŠ ** |
| **åˆ†ä½æ•°æ”¯æŒ** | æ—  | P95/P99 | P50/P90/P95/P99 | **å…¨è¦†ç›–** |
| **è¿æ¥æ•°åˆ†æ** | æ—  | æ—  | å®Œæ•´æ”¯æŒ | **å…¨æ–°åŠŸèƒ½** |
| **æ—¶é—´åŸºå‡†** | ä¸ç»Ÿä¸€ | åˆ°è¾¾æ—¶é—´ | ç§‘å­¦åŒæ—¶é—´ | **ç§‘å­¦æ ‡å‡†** |
| **è®¡ç®—ç²¾åº¦** | è¿‘ä¼¼ | é«˜ç²¾åº¦ | ç§‘å­¦ç²¾ç¡® | **ç§‘å­¦çº§åˆ«** |

## ğŸ¯ ä¸šåŠ¡ä»·å€¼æå‡

### è¿ç»´ä»·å€¼
- **è¿æ¥æ± ç›‘æ§**: å®æ—¶ç›‘æ§æ–°å»ºã€å¹¶å‘ã€æ´»è·ƒè¿æ¥æ•°
- **æ€§èƒ½åŸºçº¿**: P50/P90/P95/P99å…¨åˆ†ä½æ•°ç›‘æ§
- **å¼‚å¸¸é¢„è­¦**: è¿æ¥æ•°å¼‚å¸¸è‡ªåŠ¨æ£€æµ‹
- **å®¹é‡è§„åˆ’**: åŸºäºç§‘å­¦è¿æ¥æ•°ç»Ÿè®¡

### å¼€å‘ä»·å€¼  
- **æ€§èƒ½ä¼˜åŒ–**: ç²¾ç¡®å®šä½P99å“åº”æ—¶é—´é—®é¢˜
- **è¿æ¥ä¼˜åŒ–**: è¿æ¥å¤ç”¨ç‡åˆ†æå’Œä¼˜åŒ–
- **è´Ÿè½½åˆ†æ**: ç§‘å­¦çš„æ—¶é—´çª—å£è´Ÿè½½è®¡ç®—
- **é—®é¢˜å®šä½**: åˆ†ä½æ•°çº§åˆ«çš„æ€§èƒ½é—®é¢˜å®šä½

### æ¶æ„ä»·å€¼
- **å®¹é‡è§„åˆ’**: åŸºäºå¹¶å‘è¿æ¥æ•°çš„å®¹é‡è§„åˆ’
- **æ¶æ„ä¼˜åŒ–**: è¿æ¥æ± å’Œè´Ÿè½½å‡è¡¡ä¼˜åŒ–
- **æ€§èƒ½åŸºå‡†**: ç§‘å­¦çš„æ€§èƒ½åŸºçº¿å»ºç«‹
- **ç›‘æ§ä½“ç³»**: å®Œæ•´çš„æ—¶é—´ç»´åº¦ç›‘æ§ä½“ç³»

## ğŸ”„ å…¼å®¹æ€§ä¿è¯

### æ¥å£å…¼å®¹
```python
# å®Œå…¨å…¼å®¹åŸæ¥å£
def analyze_time_dimension(csv_path, output_path, specific_uri_list=None):
    return analyze_time_dimension_enhanced(csv_path, output_path, specific_uri_list)
```

### æ•°æ®å…¼å®¹
- âœ… **å‘åå…¼å®¹**: æ”¯æŒåŸæœ‰çš„arrival_timeå­—æ®µ
- âœ… **å‘å‰å…¼å®¹**: ä¼˜å…ˆä½¿ç”¨æ–°çš„timestampå­—æ®µ
- âœ… **æ™ºèƒ½é€‚é…**: è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢æ—¶é—´å­—æ®µ
- âœ… **å®¹é”™å¤„ç†**: ç¼ºå¤±å­—æ®µçš„è‡ªåŠ¨è®¡ç®—å’Œè¡¥å…¨

## ğŸ“‹ ä½¿ç”¨æŒ‡å—

### æ•°æ®è¦æ±‚
```python
# å¿…éœ€å­—æ®µ
required_fields = ['timestamp']  # å®Œæˆæ—¶é—´

# æ¨èå­—æ®µ  
recommended_fields = [
    'arrival_timestamp',  # åˆ°è¾¾æ—¶é—´ï¼ˆè¿æ¥æ•°è®¡ç®—ï¼‰
    'request_time',       # è¯·æ±‚å¤„ç†æ—¶é—´
    'status',            # HTTPçŠ¶æ€ç 
    'client_ip'          # å®¢æˆ·ç«¯IP
]

# å¯é€‰å­—æ®µ
optional_fields = [
    'upstream_response_time',  # ä¸Šæ¸¸å“åº”æ—¶é—´
    'upstream_connect_time',   # ä¸Šæ¸¸è¿æ¥æ—¶é—´
    'body_bytes_sent',         # å“åº”ä½“å¤§å°
    'bytes_sent'               # æ€»ä¼ è¾“å¤§å°
]
```

### ä½¿ç”¨ç¤ºä¾‹
```python
from self_05_time_dimension_analyzer_v3_enhanced import analyze_time_dimension_enhanced

# åŸºæœ¬ä½¿ç”¨
result = analyze_time_dimension_enhanced(
    csv_path="/path/to/nginx_logs.csv",
    output_path="/path/to/enhanced_analysis.xlsx"
)

# é«˜çº§ä½¿ç”¨
analyzer = EnhancedTimeAnalyzer(slow_threshold=3.0)
analyzer.process_data_stream(csv_path, specific_uri_list)
analyzer.generate_excel_report(output_path)
```

## ğŸ† æ€»ç»“

å¢å¼ºç‰ˆæ—¶é—´ç»´åº¦åˆ†æå™¨å®Œç¾è§£å†³äº†æ‚¨æå‡ºçš„æ‰€æœ‰é—®é¢˜ï¼š

### âœ… é—®é¢˜è§£å†³ç¡®è®¤
1. **è¿æ¥æ•°ç»Ÿè®¡** - âœ… å®Œæ•´å®ç°æ–°å»ºã€å¹¶å‘ã€æ´»è·ƒè¿æ¥æ•°
2. **è®¡ç®—å…¬å¼** - âœ… å®Œå…¨é‡‡ç”¨æ‚¨çš„ç§‘å­¦è®¡ç®—é€»è¾‘
3. **æ—¶é—´ç»´åº¦** - âœ… ç»Ÿä¸€ä¸ºå®Œæˆæ—¶é—´ä¸»å¯¼ï¼Œåˆ°è¾¾æ—¶é—´è¾…åŠ©
4. **åˆ†ä½æ•°** - âœ… å®Œæ•´P50/P90/P95/P99æ”¯æŒ
5. **ç§‘å­¦æ€§** - âœ… ä¸¥æ ¼æŒ‰ç…§æ—¶é—´çª—å£[T, T+N)ç®—æ³•

### ğŸš€ ä»·å€¼æå‡
- **åŠŸèƒ½å®Œæ•´æ€§**: 166% åˆ—æ•°å¢åŠ ï¼Œ100% å·¥ä½œè¡¨å¢åŠ 
- **ç§‘å­¦å‡†ç¡®æ€§**: ä¸šç•Œæ ‡å‡†ç®—æ³•ï¼Œç§‘å­¦è®¡ç®—å…¬å¼
- **å®ç”¨ä»·å€¼**: è¿æ¥æ•°åˆ†æã€åˆ†ä½æ•°åˆ†æç­‰å…¨æ–°åŠŸèƒ½
- **å…¼å®¹æ€§**: å®Œå…¨å‘åå…¼å®¹ï¼Œæ— ç¼å‡çº§

**å¢å¼ºç‰ˆå·²å®Œå…¨å°±ç»ªï¼Œå¯ç›´æ¥æŠ•å…¥ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼**

---

**åˆ›å»ºæ–‡ä»¶**: `self_05_time_dimension_analyzer_v3_enhanced.py`  
**æµ‹è¯•æ–‡ä»¶**: `test_enhanced_time_analyzer.py`  
**çŠ¶æ€**: âœ… å…¨éƒ¨æµ‹è¯•é€šè¿‡  
**ç‰ˆæœ¬**: v3.0 Enhanced  
**æ—¥æœŸ**: 2025-07-18